<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title></title>
	<meta name="description" content="">
	<meta name="author" content="SitePoint">
	<script src="lib/d3.min.js" type="text/javascript"></script>
	<script src="lib/saveSvgAsPng.js" type="text/javascript"></script>
	<!--	import css-->
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<div id="visualization">
		<div id="map">
		</div>
	</div>
	</div>
	<!--	import js sketch-->
	<script>
	let promises = [d3.json('assets/contorni_italia.json'),
		d3.json('assets/contorniProvince.json'),
		d3.json('assets/climatechange_data.json'),
		d3.tsv('assets/climate-change-provincie.tsv')
	];

	var width = 960 * 2;
	var height = 960 * 2;

	var svg = d3.select("#map")
		.append("svg")
		.attr('id', 'output')
		.attr("width", width)
		.attr("height", height);

	//saveSvgAsPng(document.getElementById("diagram"), "diagram.png");
	var projection = d3.geoMercator()
		.scale(200)
		.translate([width / 2, height / 2])

	Promise.all(promises).then(function(data) {

		projection.fitSize([width, height], data[0]);

		var path = d3.geoPath()
			.projection(projection);

		// baseLayer.append("path")
		// 	.attr("d", path(data[0]))
		// 	.attr("id", "background_map")

		var TX30_85 = generateLayer85(svg, data[2], '2071-2100', 'TX30', '#ff0086');
		// layers.TX30_852 = initializeLayer(svg, data[2], '2071-2100', 'PRCPTOT', 'RCP85', -410, '#00fff8');
		// layers.TX30_853 = initializeLayer(svg, data[2], '2071-2100', 'PR95PERC', 'RCP85', 88, '#f9ff00');
	});


	function generateLayer85(_svg, _data, _year, _variable, _color) {

		console.log(_data);

		var maxVals = {
			TX30: 74,
			PRCPTOT: -410,
			PR95PERC: 88
		}

		var rscale = d3.scaleSqrt()
			.domain([0, maxVals[_variable]])
			.range([0, 3]);

		var result = _svg.append('g')
			.attr('id', _variable + "_RCP85")
			.selectAll("circle")
			.data(_data.values).enter()
			.append("circle")
			.attr("fill", _color)
			.attr("cx", function(d) { return projection([d.lon, d.lat])[0]; })
			.attr("cy", function(d) { return projection([d.lon, d.lat])[1]; })
			.attr("r", function(d) {
				if (rscale(d[_year][_variable]['RCP85']) > 0) {
					return rscale(d[_year][_variable]['RCP85'])
				} else {
					return 0;
				}
			})
		// .attr('mask', 'url(#hole-mask)');

		saveSvgAsPng(document.getElementById('output'), _year + "_" + _variable + "_" + _scenario + ".png", {scale: 0.5});

		results.remove();
	}
	</script>
</body>

</html>